// Decompiled with JetBrains decompiler
// Type: VanillaQuestsExpandedCryptoforge.QuestNode_Root_CryptoforgeChapter1
// Assembly: VanillaQuestsExpandedCryptoforge, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 2EB4E694-B7D1-4E94-B7E3-FD665CFCBE15
// Assembly location: C:\Program Files (x86)\Steam\steamapps\workshop\content\294100\3461526070\1.6\Assemblies\VanillaQuestsExpandedCryptoforge.dll

using RimWorld;
using RimWorld.Planet;
using RimWorld.QuestGen;
using System;
using System.Collections.Generic;
using Verse;

#nullable disable
namespace VanillaQuestsExpandedCryptoforge;

public class QuestNode_Root_CryptoforgeChapter1 : QuestNode_Site
{
  public override SitePartDef QuestSite => InternalDefOf.VQE_CryptoforgeChapter1Site;

  protected virtual void RunInt()
  {
    List<BiomeDef> allowedBiomes = new List<BiomeDef>()
    {
      BiomeDefOf.IceSheet,
      BiomeDefOf.SeaIce,
      BiomeDefOf.Tundra,
      BiomeDefOf.BorealForest
    };
    Quest quest;
    Slate slate;
    float points;
    int tile;
    if (!this.PrepareQuest(out quest, out slate, out Map _, out points, out tile, (Predicate<int>) (x => ((Tile) Find.WorldGrid[x]).hilliness == 1), allowedBiomes))
    {
      Log.Error("Failed to find a suitable site tile for the Cryptoforge Chapter1 quest.");
    }
    else
    {
      Faction parentFaction = Faction.OfMechanoids ?? Find.FactionManager.RandomEnemyFaction(false, false, false, (TechLevel) 0);
      string siteMapGeneratedSignal;
      Site site = this.GenerateSite(quest, slate, points, tile, parentFaction, out siteMapGeneratedSignal, false);
      QuestPart_EndQuestOnScanSignals questOnScanSignals = new QuestPart_EndQuestOnScanSignals();
      questOnScanSignals.mapParent = (MapParent) site;
      questOnScanSignals.inSignalEnable = siteMapGeneratedSignal;
      questOnScanSignals.scanningBuilding = InternalDefOf.VQE_FrozenScanningRelay;
      questOnScanSignals.maxSignalsCount = 2;
      questOnScanSignals.inSignal = QuestGenUtility.HardcodedSignalWithQuestID("site.Scanned_" + ((Def) InternalDefOf.VQE_FrozenScanningRelay).defName);
      quest.AddPart((QuestPart) questOnScanSignals);
    }
  }

  protected override bool TestRunInt(Slate slate) => true;
}
